---
title: "Analysis of temporal trends in potential COVID-19 cases reported through NHS Pathways"
author: 
- Quentin J. Leclerc
- Emily S. Nightingale
- Sam Abbott
- CMMID COVID-19 Working Group
- Thibaut Jombart
date: "`r format(Sys.time(), '%A %d %B %Y')`"
output:
  md_document
toc: false
urlcolor: blue
bibliography: ../data/bib/nhs_paths_bib.bib
csl: ../data/bib/vancouver-brackets.csl
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE)

library(rio)
library(dplyr)
library(ggplot2)
library(knitr)
library(kableExtra)
library(bookdown)
library(here)
library(reportfactory)

```

```{r load_data}

reportfactory::rfh_load_scripts()

#identify latest compilation directory
last_output_dir <- reportfactory::filter_log(
  readRDS(here::here(".compile_log.rds")),
  file = "nhs_pathways_analysis_2020-05-13.Rmd",
  most_recent = TRUE)[[1]]$output_dir

tables_folder <- file.path(last_output_dir, "excel_tables")


#load most recent NHS Pathways date
x <- import_pathways()
database_date <- attr(x, "timestamp")


#load results from latest data
latest_data <- rio::import(file.path(tables_folder, "r_all_sliding.xlsx"))

min_all <- which.min(latest_data$r)

latest_data_grouped <- latest_data %>%
  group_by(w_max) %>%
  summarise(r = mean(r, na.rm = TRUE),
            r_lower = mean(lower_95, na.rm = TRUE),
            r_upper = mean(upper_95, na.rm = TRUE),
            halving = mean(halving_t, na.rm = TRUE),
            halving_lower = mean(halving_t_lower_95, na.rm = TRUE),
            halving_upper = mean(halving_t_upper_95, na.rm = TRUE),
            R = mean(R, na.rm = TRUE),
            R_lower = mean(R_lower_95, na.rm = TRUE),
            R_upper = mean(R_upper_95, na.rm = TRUE)) %>%
  filter(w_max == max(w_max))

latest_cor <- rio::import(file.path(tables_folder, "lag_cor.xlsx"))
latest_reg <- rio::import(file.path(tables_folder, "lag_mod.rds"))

l_opt <- which.max(latest_cor$r)

Rsq <- function(x) {
  1 - (x$deviance / x$null.deviance)
}


```


<!-- ======================================================= -->
<!-- ======================================================= -->
<!-- ======================================================= -->


***This is a summary of the latest trends seen in potential COVID-19 cases reported through NHS Pathways. The results presented here include data up to `r database_date`. For a full discussion of this analysis, please refer to our paper available [here](https://www.medrxiv.org/content/10.1101/2020.05.16.20103820v1)***


## Introduction

NHS Pathways is a triage system for public calls and online reports for medical 
care [@nhspathways]. This system is currently being used throughout England to assist 
individuals reporting potential COVID-19 symptoms. Since the 18th of March 2020,
data on daily phone calls and completed online assessments which have received
a potential COVID-19 final disposition are openly available. These assessments
are either completed via calls to 111 and 999 (which are respectively for
non-urgent, and urgent medical problems), or through 111-online self-completed
reports. The fraction of assessments corresponding to actual COVID-19 cases is
unknown, but in the absence of wide-scale testing, the NHS Pathways dataset may
be one of the best available proxies for COVID-19 incidence in the community.
While prone to self-reporting biases, it is likely to better reflect milder
cases and be less biased by different severity profiles than hospital admission
data, which by definition reflect the most acute cases. 

Here, we analyse NHS Pathways data until `r database_date` to assess the temporal
dynamics of COVID-19 in England. Specifically, we investigated potential changes
in the growth rate of the epidemic over time, and compared the observed patterns
across NHS regions. We derived time-varying estimates of the growth rates,
halving time and effective reproduction numbers for the different regions. We
also assessed the potential correlation between NHS Pathways with COVID-19 daily
deaths in England, to gain an initial understanding of its possible value within
an early detection system.




<!-- ======================================================= -->
<!-- ======================================================= -->
<!-- ======================================================= -->


## Latest results

***The results below were generated with data up to `r database_date`.***

### Numbers of daily NHS Pathways report and NHS COVID-19 deaths

<br>

<img src="figures/nhs_paths/all_volume-1.png" width="70%" style="display: block; margin: auto;" />
***Figure 1. Daily potential COVID-19 cases reported through NHS Pathways and reported COVID-19-related deaths, by NHS region.*** *Pathways data include calls to 111 and 999, as well as 111-online reports. Dates correspond to the date of case report and death report, respectively, with x-axis labels corresponding to Mondays. The solid black line and grey ribbon correspond to a lowess smoother and its 95% confidence interval. The start of the lockdown in England (2020-03-23) and date at which death data were truncated to avoid bias from reporting delay (`r database_date - 21`) are highlighted by vertical lines.*

<br>

### Estimates of growth rate and effective reproduction number

<br>

<img src="figures/nhs_paths/fig2_3-1.png" width="70%" style="display: block; margin: auto;" />
***Figure 2. Estimates of daily growth rates (r) and effective reproduction numbers (R<sub>e</sub>) for potential COVID-19 cases reported through NHS Pathways.*** *Dotted lines indicate the central estimate, and ribbons their 95\% confidence intervals. Estimates are indicated at the end of the time window used for estimation, so that values of r and R<sub>e</sub> provided on a given day correspond to the 2 weeks leading up to that day.*

<br>

The lowest $$r$$ estimated across all NHS regions and for all available dates was on `r latest_data$w_max[min_all]` for the `r latest_data$nhs_region[min_all]` region at `r round(latest_data$r[min_all],3)`
(95% CI: `r round(latest_data$lower_95[min_all],3)` ; `r round(latest_data$upper_95[min_all],3)`), corresponding to a halving time of `r round(latest_data$halving_t[min_all],3)` days (95% CI:
`r round(latest_data$halving_t_lower_95[min_all],3)` ; `r round(latest_data$halving_t_upper_95[min_all],3)`) and an $$R_e$$ of `r round(latest_data$R[min_all],3)` (95% CI: `r round(latest_data$R_lower_95[min_all],3)` ; `r round(latest_data$R_upper_95[min_all],3)`).

The most recent estimate of $$r$$ averaged over all NHS regions is `r round(latest_data_grouped$r,3)` (95% CI: `r round(latest_data_grouped$r_lower,3)` ; `r round(latest_data_grouped$r_upper,3)`), corresponding to an $$R_e$$ of `r round(latest_data_grouped$R,3)` (95% CI: `r round(latest_data_grouped$R_lower,3)` ; `r round(latest_data_grouped$R_upper,3)`).


### Correlation between NHS Pathways reports and deaths

Figure 3 illustrates the observed trend in correlation across all tested lags. 
The strongest correlation between NHS Pathways reports and deaths was obtained 
with a lag of `r l_opt-1` days (Pearson's correlation = `r round(latest_cor$r[l_opt],2)`; 95% CI: `r round(latest_cor$r_low[l_opt],2)` ; `r round(latest_cor$r_hi[l_opt],2)`). 

Estimates become increasingly unstable for longer lags as the number of 
points within the overlapping time window becomes small.

<br>

<img src="figures/nhs_paths/lag_cor-1.png" width="70%" style="display: block; margin: auto;" />
***Figure 3. Pearson's correlation between deaths and potential COVID-19 cases reported through NHS Pathways, lagged between 0 and 30 days.*** *95% confidence intervals are calculated by bootstrapping with 1,000 replicates.*

<br>

Fitting a quasi-Poisson GLM, we found that over `r round(Rsq(latest_reg), 3)*100`% of the deviance in daily
reported deaths could potentially be explained by NHS Pathways reports 16 days
prior, with an average of `r round(exp(coefficients(latest_reg)[1])*coefficients(latest_reg)[2]*1000, 2)` (bootstrap 95% CI: `r round(exp(confint(latest_reg)[1])*confint(latest_reg)[2]*1000, 2)` ; `r round(exp(confint(latest_reg)[3])*confint(latest_reg)[4]*1000, 2)`) additional deaths
for every 1,000 potential COVID-19 cases reported in NHS Pathways 16 days
before (intercept = `r round(exp(coefficients(latest_reg))[1])`, 95% CI: `r round(exp(confint(latest_reg))[1])` ; `r round(exp(confint(latest_reg))[3])`; % increase per 1000 notifications =
`r round(coefficients(latest_reg)[2]*1000, 2)`, 95% CI: `r round(confint(latest_reg)[2]*100000, 2)` ; `r round(confint(latest_reg)[4]*100000, 2)`)) (Figure 4).

<br>

<img src="figures/nhs_paths/regress-1.png" width="70%" style="display: block; margin: auto;" />
***Figure 4. Daily total COVID-19 deaths reported in England, against the number of potential COVID-19 cases reported through NHS Pathways with a lag of 16 days.*** *The black line and grey ribbon correspond to predictions from the regression model and associated 95% confidence intervals.*

<br>


<!-- ======================================================= -->
<!-- ======================================================= -->
<!-- ======================================================= -->

## Methods

### Data extraction

We extracted the NHS Pathways data up to `r database_date` through the NHS Digital 
website [@nhspathways], where they are updated daily, every weekday. The number of reports
are stratified by Clinical Commissioning Group (CCG), gender and age group (0-18,
19-69 and 70-120 years old) of the patients. We mapped the CCGs to their
corresponding NHS regions using publicly available CCG data [@ccgtonhs], and used this
geographic resolution for our analysis. All dates indicated refer to the date of
reporting.

### Temporal analysis

Total numbers of reports (including all three data sources: 111 calls, 999 calls,
and 111-online reports) were modelled using quasi-Poisson generalised linear
models (GLM) with log links, to account for exponential trends as well as
over-dispersion of the data [@McCullagh1989]. Predictors included time (in days since the
first data point (2020-03-18) with interaction terms for varying slopes and
intercepts between NHS regions, and day of the week (weekend, monday, or rest of
the week) to account for potential differences in reporting over the weekend and
at the start of the week. Growth rates ($r$) for each NHS region and their 95%
confidence intervals were directly deduced from the corresponding coefficients.
All models were fitted using maximum-likelihood.

To assess potential changes of the growth rate over time, analyses were performed
over rolling windows of 14 days from the earliest available date (2020-03-18)
to the latest available one (`r database_date`). Growth rates and associated
confidence intervals were calculated for each time window. Whenever the upper
bound of $r$ was negative, corresponding halving times were calculated as
$log(0.5)/r$. Growth rates were converted to effective reproduction numbers $R_e$
using the approach described in Wallinga and Lipsitch [@Wallinga2007] and implemented in the
epitrix package [@epitrixcite], with a serial interval modelled as a gamma distribution
with mean 4.7 days and standard deviation 2.9 days [@Nishiura2020].

### Correlation with reported deaths

To test the validity of the NHS Pathways dataset as an early detection system, we
compared daily total counts of reports (including all three data sources: 111
calls, 999 calls, and 111-online reports) with publicly available NHS data on
COVID-19 daily deaths [@nhsdeaths]. This dataset includes daily counts of COVID-19 deaths
in hospitals in England NHS regions. All dates refer to the date of death. However,
the data are subject to bias from reporting delays, with more recent counts
excluding a proportion of deaths which have not yet been reported. To account for
this, we excluded data from the last 3 weeks from this analysis. 

We calculated Pearson's correlation between the daily time series of deaths and
NHS Pathways reports, lagging the reports from zero to thirty days. Approximate
95% confidence intervals for each correlation estimate were calculated by
bootstrapping with 1,000 replicates. From this we identified an optimal lag at
which the reports correlate most strongly with subsequent deaths. We then further
evaluated the potential of NHS Pathways reports lagged at this value as a
predictor, assuming a quasi-Poisson distribution for daily deaths.

All analyses were performed using the R software [@rcite], and the code is publicly
available from https://github.com/qleclerc/nhs_pathways_report and distributed
under the MIT license.


<!-- ======================================================= -->
<!-- ======================================================= -->
<!-- ======================================================= -->

## Limitations

A number of caveats may affect our results. Firstly, the data we considered are at best a proxy for the true incidence of COVID-19 in the country as they rely on self-reported symptoms interpreted by an algorithm, and were not confirmed by virological tests. This is further exacerbated by the fact that individuals might access NHS Pathways more than once to report their symptoms, which could artificially increase the numbers of potential COVID-19 cases. 

As NHS Pathways is based on self-reporting, several biases could affect the data, such as changes in service availability and delays in the uptake of the 111-online reporting system. When estimating growth rates over time and geographic regions, we implicitly assume that self-reporting behaviours have not substantially changed over time, and have been similar across different NHS regions. In reality, self-reporting could be strongly biased by behavioural issues, such as the effect of news coverage which might lead individuals to pay more attention to their symptoms and report them. Inversely, individuals could reduce their perception of the risk of the disease over time as they become used to hearing about it daily, which would decrease their likelihood of noticing and reporting symptoms. Similarly, differences in self-reporting behaviours across various age groups would likely bias the age composition of the potential COVID-19 cases reported here.

While NHS Pathways data may better capture the epidemic in the community than hospitalisation data, these data do not only reflect community cases. In fact, a fraction of cases reported through 999 are likely to be hospitalised, as well as smaller proportions of cases reported through 111 calls and 111-online. Therefore, the data we considered here most likely reflect the epidemic as a whole, rather than just in the community. We also note that all results presented rely on dates of calls or online reports, so that estimates of transmissibility are likely lagged by a few days compared to the true, underlying epidemic. Unfortunately, the delays from exposure to notification through NHS Pathways cannot be estimated from current publicly available data.


<!-- ======================================================= -->
<!-- ======================================================= -->
<!-- ======================================================= -->


## References

