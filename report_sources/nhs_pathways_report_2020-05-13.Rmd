---
title: "Analysis of temporal trends in potential COVID-19 cases reported through NHS Pathways"
author: 
- Quentin J. Leclerc
- Emily S. Nightingale
- Samuel Abbott
- CMMID COVID-19 Working Group
- Thibaut Jombart
date: "`r format(Sys.time(), '%A %d %B %Y')`"
output:
  #bookdown::pdf_document2
  md_document
header-includes:
 \usepackage{xcolor}
 \usepackage{float}
 \floatplacement{figure}{H}
 \floatplacement{table}{H}
 \usepackage[labelfont=bf]{caption}
urlcolor: blue
bibliography: ../data/bib/nhs_paths_bib.bib
csl: ../data/bib/vancouver-brackets.csl
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE)

library(rio)
library(dplyr)
library(ggplot2)
library(sf)
library(knitr)
library(kableExtra)
library(bookdown)
library(here)
library(reportfactory)

```

```{r load_data}
reportfactory::rfh_load_scripts()

last_output_dir <- reportfactory::filter_log(
  readRDS(here::here(".compile_log.rds")),
  file = "nhs_pathways_analysis_2020-05-13.Rmd",
  most_recent = TRUE)[[1]]$output_dir

figure_folder <- file.path(last_output_dir, "figures", "nhs_paths")
tables_folder <- file.path(last_output_dir, "excel_tables")

latest_data <- rio::import(file.path(tables_folder, "r_all_sliding.xlsx"))

min_all <- which.min(latest_data$r)

latest_data_grouped <- latest_data %>%
  group_by(w_max) %>%
  summarise(r = mean(r, na.rm = TRUE),
            r_lower = mean(lower_95, na.rm = TRUE),
            r_upper = mean(upper_95, na.rm = TRUE),
            halving = mean(halving_t, na.rm = TRUE),
            halving_lower = mean(halving_t_lower_95, na.rm = TRUE),
            halving_upper = mean(halving_t_upper_95, na.rm = TRUE),
            R = mean(R, na.rm = TRUE),
            R_lower = mean(R_lower_95, na.rm = TRUE),
            R_upper = mean(R_upper_95, na.rm = TRUE)) %>%
  filter(w_max == max(w_max))


x <- import_pathways()
database_date <- attr(x, "timestamp")

```

<!-- ======================================================= -->
<!-- ======================================================= -->
<!-- ======================================================= -->


***This is a summary of the latest trends seen in potential COVID-19 cases reported through NHS Pathways. The results presented here include data up to `r database_date`. For a full discussion of this analysis, please refer to our paper available [here](link)***


# Introduction

NHS Pathways is a triage system for public calls and online reports for medical 
care [5]. This system is currently being used throughout England to assist 
individuals reporting potential COVID-19 symptoms. Since the 18th of March 2020,
data on daily phone calls and completed online assessments which have received
a potential COVID-19 final disposition are openly available. These assessments
are either completed via calls to 111 and 999 (which are respectively for
non-urgent, and urgent medical problems), or through 111-online self-completed
reports. The fraction of assessments corresponding to actual COVID-19 cases is
unknown, but in the absence of wide-scale testing, the NHS Pathways dataset may
be one of the best available proxies for COVID-19 incidence in the community.
While prone to self-reporting biases, it is likely to better reflect milder
cases and be less biased by different severity profiles than hospital admission
data, which by definition reflect the most acute cases. 

Here, we analyse NHS Pathways data until `r database_date` to assess the temporal
dynamics of COVID-19 in England. Specifically, we investigated potential changes
in the growth rate of the epidemic over time, and compared the observed patterns
across NHS regions. We derived time-varying estimates of the growth rates,
halving time and effective reproduction numbers for the different regions. We
also assessed the potential correlation between NHS Pathways with COVID-19 daily
deaths in England, to gain an initial understanding of its possible value within
an early detection system.




<!-- ======================================================= -->
<!-- ======================================================= -->
<!-- ======================================================= -->

# Methods

## Data extraction

We extracted the NHS Pathways data up to `r database_date` through the NHS Digital 
website [REF], where they are updated daily, every weekday. The number of reports
are stratified by Clinical Commissioning Group (CCG), gender and age group (0-18,
19-69 and 70-120 years old) of the patients. We mapped the CCGs to their
corresponding NHS regions using publicly available CCG data [REF], and used this
geographic resolution for our analysis. All dates indicated refer to the date of
reporting.

## Temporal analysis

Total numbers of reports (including all three data sources: 111 calls, 999 calls,
and 111-online reports) were modelled using quasi-Poisson generalised linear
models (GLM) with log links, to account for exponential trends as well as
over-dispersion of the data [8]. Predictors included time (in days since the
first data point (18/03/2020)) with interaction terms for varying slopes and
intercepts between NHS regions, and day of the week (weekend, monday, or rest of
the week) to account for potential differences in reporting over the weekend and
at the start of the week. Growth rates ($r$) for each NHS region and their 95%
confidence intervals were directly deduced from the corresponding coefficients.
All models were fitted using maximum-likelihood.

To assess potential changes of the growth rate over time, analyses were performed
over rolling windows of 14 days from the earliest available date (Wednesday 18
March 2020) to the latest available one (Tuesday 12 May 2020) (see Figure S1 in
Supplementary Material for a sensitivity analysis). Growth rates and associated
confidence intervals were calculated for each time window. Whenever the upper
bound of $r$ was negative, corresponding halving times were calculated as
$log(0.5)/r$. Growth rates were converted to effective reproduction numbers $R_e$
using the approach described in Wallinga and Lipsitch [9] and implemented in the
epitrix package [10], with a serial interval modelled as a gamma distribution
with mean 4.7 days and standard deviation 2.9 days [11].

## Correlation with reported deaths

To test the validity of the NHS Pathways dataset as an early detection system, we
compared daily total counts of reports (including all three data sources: 111
calls, 999 calls, and 111-online reports) with publicly available NHS data on
COVID-19 daily deaths [12]. This dataset includes daily counts of COVID-19 deaths
in hospitals in England NHS regions. All dates refer to the date of death. However,
the data are subject to bias from reporting delays, with more recent counts
excluding a proportion of deaths which have not yet been reported. To account for
this, we excluded data from the last 3 weeks from this analysis. 

We calculated Pearson's correlation between the daily time series of deaths and
NHS Pathways reports, lagging the reports from zero to thirty days. Approximate
95% confidence intervals for each correlation estimate were calculated by
bootstrapping with 1,000 replicates. From this we identified an optimal lag at
which the reports correlate most strongly with subsequent deaths. We then further
evaluated the potential of NHS Pathways reports lagged at this value as a
predictor, assuming a quasi-Poisson distribution for daily deaths.

All analyses were performed using the R software [13], and the code is publicly
available from https://github.com/qleclerc/nhs_pathways_report and distributed
under the MIT license.


<!-- ======================================================= -->
<!-- ======================================================= -->
<!-- ======================================================= -->


# Latest results

**The results below were generated with data up to `r database_date`.**

## Numbers of daily NHS Pathways report and NHS COVID-19 deaths

```{r volume, fig.cap="\\small \\textbf{Daily potential COVID-19 cases reported through NHS Pathways and reported COVID-19-related deaths, by NHS region.} Pathways data include calls to 111 and 999, as well as 111-online reports. Dates correspond to the date of case report and death report, respectively, with x-axis labels corresponding to Mondays. The solid black line and grey ribbon correspond to a lowess smoother and its 95\\% confidence interval. The start of the lockdown in England (23/03/2020) and date at which death data were truncated to avoid bias from reporting delay (20/04/202) are highlighted by vertical lines.", out.width = "70%", fig.align = "center"}

knitr::include_graphics(file.path(figure_folder, "all_volume-1.png"))

```

## Estimates of growth rate and effective reproduction number

Daily estimates can be seen in Figure \@ref(fig::estimates).

The lowest $r$ estimated across all NHS regions and for all available dates was on `r latest_data$w_max[min_all]` for the `r latest_data$nhs_region[min_all]` region at `r latest_data$r[min_all]`
(95% CI: `r latest_data$lower_95[min_all]` - `r latest_data$upper_95[min_all]`), corresponding to a halving time of `r latest_data$halving_t[min_all]` days (95% CI:
`r latest_data$halving_t_lower_95[min_all]` - `r latest_data$halving_t_upper_95[min_all]`) and an $R_e$ of `r latest_data$R[min_all]` (95% CI: `r latest_data$R_lower_95[min_all]` - `r latest_data$R_upper_95[min_all]`).


```{r estimates, fig.cap="\\small \\textbf{Estimates of daily growth rates (r) and effective reproduction numbers (Re) for potential COVID-19 cases reported through NHS Pathways.} Dotted lines indicate the central estimate, and ribbons their 95\\% confidence intervals. Estimates are indicated at the end of the time window used for estimation, so that values of r and Re provided on a given day correspond to the 2 weeks leading up to that day.", out.width = "70%", fig.align = "center"}

knitr::include_graphics(file.path(figure_folder, "fig2_3-1.png"))

```


The most recent estimate of $r$ averaged over all NHS regions is `r latest_data_grouped$r` (95% CI: `r latest_data_grouped$lower_95` - `r latest_data_grouped$upper_95`), corresponding to an $R_e$ of `r latest_data_grouped$R` (95% CI: `r latest_data_grouped$R_lower_95` - `r latest_data_grouped$R_upper_95`).


## Correlation between NHS Pathways reports and deaths

Figure \@ref(fig:corplot) illustrates the observed trend in correlation across all tested lags. 
The strongest correlation between NHS Pathways reports and deaths was obtained 
with a lag of `r VAL` days (Pearson's correlation = `r VAL`; 95% CI: `r VAL` - `r VAL`). 

Estimates become increasingly unstable for longer lags as the number of 
points within the overlapping time window becomes small.

Fitting a quasi-Poisson GLM, we found that over `r VAL %` of the deviance in daily
reported deaths could potentially be explained by NHS Pathways reports 16 days
prior, with an average of 1.87 (bootstrap 95% CI: 1.66 - 2.01) additional deaths
for every 1,000 potential COVID-19 cases reported in NHS Pathways 16 days
before (intercept = 412, 95% CI: 376 - 452; % increase per 1000 notifications =
0.45, 95% CI: 0.37 - 0.53)) (Figure 4).


```{r corplot, fig.cap="\\small \\textbf{Pearson's correlation between deaths and potential COVID-19 cases reported through NHS Pathways, lagged between 0 and 30 days.} 95\\% confidence intervals are calculated by bootstrapping with 1,000 replicates..", out.width = "70%", fig.align = "center"}

knitr::include_graphics(file.path(figure_folder, "lag_cor-1.png"))

```

Figure \@ref(fig:reportsvsdeaths)

```{r reportsvsdeaths, fig.cap="\\small \\textbf{Daily total COVID-19 deaths reported in England between 03/04 and 21/04, against the number of potential COVID-19 cases reported through NHS Pathways with a lag of 16 days (between 18/03 and 05/04).} The black line and grey ribbon correspond to predictions from the regression model and associated 95\\% confidence intervals. The coefficient of determination indicates that 85.8\\% of the deviance in reported deaths is linearly explained by NHS Pathways reports.", out.width = "70%", fig.align = "center"}

knitr::include_graphics(file.path(figure_folder, "regress-1.png"))

```







\newpage
<!-- ======================================================= -->
<!-- ======================================================= -->
<!-- ======================================================= -->

# References
